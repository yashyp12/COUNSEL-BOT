{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="assessment-container">
    <div class="container mt-4">
        <div class="row">
            <div class="col-lg-8 offset-lg-2">
                <div class="assessment-header text-center mb-4">
                    <h1 class="display-4 text-white mb-3">Career Assessment</h1>
                    <p class="lead text-white">Answer these questions to discover your ideal career path</p>
                    <div class="progress mb-4" style="height: 10px;">
                        <div class="progress-bar" role="progressbar" style="width: 0%;" id="progressBar">
                            <span class="progress-text">0%</span>
                        </div>
                    </div>
                </div>

                <form method="post" id="assessmentForm">
                    {% csrf_token %}
                    
                    {% for question in questions %}
                    <div class="question-card" data-question="{{ forloop.counter }}">
                        <div class="card glassmorphism">
                            <div class="card-body">
                                <div class="question-header">
                                    <span class="question-number">Question {{ forloop.counter }}/{{ questions|length }}</span>
                                    <span class="question-type badge">{{ question.question_type }}</span>
                                </div>
                                
                                <h3 class="question-text mt-3 mb-4">{{ question.question_text }}</h3>
                                
                                <div class="options-container" data-question-id="{{ forloop.counter }}">
                                    {% for option in question.options %}
                                    <div class="option-wrapper mb-3">
                                        <input type="radio" 
                                               name="question_{{ question.id }}" 
                                               id="q{{ question.id }}_option{{ forloop.counter }}"
                                               value="{{ option }}" 
                                               required
                                               class="option-input"
                                               data-question-id="{{ question.id }}">
                                        <label class="option-label" 
                                               for="q{{ question.id }}_option{{ forloop.counter }}">
                                            {{ option }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>

                                <div class="navigation-buttons mt-4">
                                    {% if not forloop.first %}
                                    <button type="button" class="btn btn-outline-primary prev-btn" onclick="previousQuestion(event)">
                                        <i class="fas fa-arrow-left"></i> Previous
                                    </button>
                                    {% endif %}
                                    
                                    {% if forloop.last %}
                                    <button type="button" class="btn btn-primary submit-btn" onclick="submitAssessment(event)">
                                        Get Career Recommendations <i class="fas fa-arrow-right"></i>
                                    </button>
                                    {% else %}
                                    <button type="button" class="btn btn-primary next-btn" onclick="nextQuestion(event)">
                                        Next <i class="fas fa-arrow-right"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </form>
            </div>
        </div>
    </div>
</div>

<style>
.assessment-container {
    min-height: 100vh;
    padding: 40px 0;
    background: linear-gradient(135deg, #1a237e, #0d47a1);
    position: relative;
}

.assessment-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url("{% static 'img/pattern.png' %}") repeat;
    opacity: 0.1;
}

.glassmorphism {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 15px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.question-card {
    display: none;
    animation: slideIn 0.5s ease-out;
}

.question-card.active {
    display: block;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.question-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.question-number {
    font-size: 1.1rem;
    color: #fff;
    font-weight: 500;
}

.question-type {
    background: rgba(255, 255, 255, 0.2);
    color: #fff;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
}

.question-text {
    color: #fff;
    font-size: 1.4rem;
    line-height: 1.6;
}

.option-wrapper {
    position: relative;
}

.option-input {
    display: none;
}

.option-label {
    display: block;
    padding: 15px 20px;
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    color: #fff;
    cursor: pointer;
    transition: all 0.3s ease;
}

.option-label:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
}

.option-input:checked + .option-label {
    background: rgba(33, 150, 243, 0.3);
    border-color: #2196f3;
    box-shadow: 0 0 15px rgba(33, 150, 243, 0.3);
}

.progress {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    overflow: hidden;
}

.progress-bar {
    background: linear-gradient(90deg, #2196f3, #64b5f6);
    transition: width 0.3s ease;
}

.progress-text {
    position: absolute;
    right: 10px;
    color: #fff;
    font-size: 12px;
    line-height: 10px;
}

.navigation-buttons {
    display: flex;
    justify-content: space-between;
    gap: 15px;
}

.btn {
    padding: 12px 25px;
    border-radius: 10px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn-primary {
    background: linear-gradient(135deg, #2196f3, #1976d2);
    border: none;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
}

.btn-outline-primary {
    color: #fff;
    border: 2px solid rgba(255, 255, 255, 0.5);
    background: transparent;
}

.btn-outline-primary:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: #fff;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const questions = document.querySelectorAll('.question-card');
    const progressBar = document.getElementById('progressBar');
    let currentQuestion = 0;
    const totalQuestions = questions.length;
    
    // Initialize responses object to store answers
    const responses = {};

    function updateProgress() {
        const progress = ((currentQuestion + 1) / totalQuestions) * 100;
        progressBar.style.width = `${progress}%`;
        progressBar.querySelector('.progress-text').textContent = `${Math.round(progress)}%`;
    }

    function showQuestion(index) {
        questions.forEach(q => q.classList.remove('active'));
        questions[index].classList.add('active');
        updateProgress();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Show first question on load
    showQuestion(0);

    // Store response when an option is selected
    document.querySelectorAll('.option-input').forEach(input => {
        input.addEventListener('change', function() {
            const questionId = this.getAttribute('data-question-id');
            responses[questionId] = this.value;
        });
    });

    window.nextQuestion = function(event) {
        event.preventDefault();
        const currentCard = questions[currentQuestion];
        const questionId = currentCard.querySelector('.options-container').getAttribute('data-question-id');
        
        if (!responses[questionId]) {
            showNotification('Please select an answer before proceeding', 'warning');
            return;
        }

        if (currentQuestion < questions.length - 1) {
            currentQuestion++;
            showQuestion(currentQuestion);
        }
    };

    window.previousQuestion = function(event) {
        event.preventDefault();
        if (currentQuestion > 0) {
            currentQuestion--;
            showQuestion(currentQuestion);
        }
    };

    window.submitAssessment = function(event) {
        event.preventDefault();
        
        // Collect all responses
        const responses = {};
        const questionCards = document.querySelectorAll('.question-card');
        let allAnswered = true;
        
        questionCards.forEach((card, index) => {
            const questionText = card.querySelector('.question-text').textContent.trim();
            const selectedOption = card.querySelector('.option-input:checked');
            
            if (!selectedOption) {
                allAnswered = false;
                console.warn(`Question ${index + 1} not answered: ${questionText}`);
                return;
            }
            
            responses[questionText] = selectedOption.value;
            console.log(`Q${index + 1}: ${questionText} => ${selectedOption.value}`);
        });
        
        if (!allAnswered) {
            showNotification('Please answer all questions before submitting.', 'warning');
            return;
        }

        // Show loading state
        const submitBtn = event.target;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

        // Prepare the data
        const formData = {
            responses: responses
        };
        
        console.log('Submitting responses:', formData);

        // Get CSRF token
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Submit using fetch
        fetch(window.location.href, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP ${response.status}: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.status === 'success') {
                showNotification('Assessment submitted successfully! Redirecting...', 'success');
                setTimeout(() => {
                    window.location.href = data.redirect_url || '/recommendations/';
                }, 1000);
            } else {
                showNotification(data.message || 'Error submitting assessment', 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Get Career Recommendations <i class="fas fa-arrow-right"></i>';
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            showNotification(`Error submitting assessment: ${error.message}`, 'error');
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Get Career Recommendations <i class="fas fa-arrow-right"></i>';
        });
    };

    // Add keyboard navigation
    document.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowRight' || e.key === 'Enter') {
            const activeQuestion = document.querySelector('.question-card.active');
            const nextBtn = activeQuestion.querySelector('.next-btn');
            const submitBtn = activeQuestion.querySelector('.submit-btn');
            if (nextBtn) nextBtn.click();
            else if (submitBtn) submitBtn.click();
        } else if (e.key === 'ArrowLeft') {
            document.querySelector('.question-card.active .prev-btn')?.click();
        } else if (e.key >= '1' && e.key <= '4') {
            const currentOptions = document.querySelectorAll('.question-card.active .option-input');
            const index = parseInt(e.key) - 1;
            if (currentOptions[index]) {
                currentOptions[index].click();
            }
        }
    });

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <i class="fas fa-${
                    type === 'warning' ? 'exclamation-triangle' :
                    type === 'success' ? 'check-circle' :
                    type === 'error' ? 'times-circle' : 'info-circle'
                }"></i>
                <span>${message}</span>
            </div>
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }, 100);
    }
});
</script>
{% endblock %} 